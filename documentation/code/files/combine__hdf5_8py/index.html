<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://gambitbsm.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://gambitbsm.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://gambitbsm.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var e=localStorage.getItem("theme");e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://gambitbsm.github.io/main.2b4f179ba5137bf560410d5863d012cb95c0a7504da18190247e40a43544a8252fba5dc321f967a611ca9a4d80dec44fabc75d108c7c0e4e8ed381ec007b7391.css integrity="sha512-K08Xm6UTe/VgQQ1YY9ASy5XAp1BNoYGQJH5ApDVEqCUvul3DIflnphHKmk2A3sRPq8ddEIx8Dk6O04HsAHtzkQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>file scripts/combine_hdf5.py - GAMBIT</title><meta name=description content="[No description available]"><link rel=canonical href=https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="file scripts/combine_hdf5.py"><meta property="og:description" content="[No description available]"><meta property="og:url" content="https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/"><meta property="og:site_name" content="GAMBIT"><meta property="og:image" content="https://gambitbsm.github.io/gambit_logo.png"><meta property="og:image:alt" content="GAMBIT"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="file scripts/combine_hdf5.py"><meta name=twitter:description content="[No description available]"><meta name=twitter:image content="https://gambitbsm.github.io/gambit_logo.png"><meta name=twitter:image:alt content="file scripts/combine_hdf5.py"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://gambitbsm.github.io/#/schema/organization/1","name":"Doks","url":"https://gambitbsm.github.io/","sameAs":["https://github.com/GambitBSM"],"logo":{"@type":"ImageObject","@id":"https://gambitbsm.github.io/#/schema/image/1","url":"https://gambitbsm.github.io/logo-doks.png","width":450,"height":416,"caption":"Doks"},"image":{"@id":"https://gambitbsm.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://gambitbsm.github.io/#/schema/website/1","url":"https://gambitbsm.github.io/","name":"GAMBIT","description":"Documentation for the Global And Modular BSM Inference Tool","publisher":{"@id":"https://gambitbsm.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/","url":"https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/","name":"file scripts\/combine_hdf5.py","description":"[No description available]","isPartOf":{"@id":"https://gambitbsm.github.io/#/schema/website/1"},"about":{"@id":"https://gambitbsm.github.io/#/schema/organization/1"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"0001-01-01T00:00:00CET","breadcrumb":{"@id":"https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/"]}]},{"@type":"BreadcrumbList","@id":"https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://gambitbsm.github.io/","url":"https://gambitbsm.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://gambitbsm.github.io/documentation/","url":"https://gambitbsm.github.io/documentation/","name":"Documentation"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://gambitbsm.github.io/documentation/code/","url":"https://gambitbsm.github.io/documentation/code/","name":"Code"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"https://gambitbsm.github.io/documentation/code/files/","url":"https://gambitbsm.github.io/documentation/code/files/","name":"Files"}},{"@type":"ListItem","position":5,"item":{"@id":"https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://gambitbsm.github.io/documentation/code/files/combine__hdf5_8py/#/schema/image/2","url":"https://gambitbsm.github.io/gambit_logo.png","contentUrl":"https://gambitbsm.github.io/gambit_logo.png","caption":"file scripts\/combine_hdf5.py"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://gambitbsm.github.io/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://gambitbsm.github.io/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://gambitbsm.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://gambitbsm.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gambitbsm.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gambitbsm.github.io/site.webmanifest></head><body class="documentation single light"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=https://gambitbsm.github.io/ aria-label=GAMBIT><img class=logo-light src=https://gambitbsm.github.io//images/gambit_logo.png width=50px>
<img class="logo-dark d-none" src=https://gambitbsm.github.io//images/gambit_logo.png width=50px>
GAMBIT</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>GAMBIT</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Releases
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.2>GAMBIT 2-2 ⧉</a></li><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.1>GAMBIT 2-1 ⧉</a></li><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.2/tags>All releases ⧉</a></li></ul></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Documentation
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=/documentation/installation/introduction/>Installation</a></li><li><a class=dropdown-item href=/documentation/examples/colliderbit_example>Examples</a></li><li><a class=dropdown-item href=/documentation/help/common_problems_and_questions/>Help</a></li><li><a class=dropdown-item href=/documentation/code/index_classes>Code Reference</a></li></ul></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Community
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=/community/publications/>Publications</a></li><li><a class=dropdown-item href=/community/talks/>Talks</a></li><li><a class=dropdown-item href=/community/members/>Members</a></li><li><a class=dropdown-item href=/community/code_of_conduct/>Code of Conduct</a></li><li><a class=dropdown-item href=/community/contact/>Contact</a></li></ul></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search site..." aria-label="Search site..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/GambitBSM><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-installation aria-expanded=false>
Installation</button><div class=collapse id=section-installation><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/installation/introduction/>Getting Started</a></li><li><a class="docs-link rounded" href=/documentation/installation/docker_usage/>Docker Usage</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_linux/>Installation for Linux</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_windows/>Installation for Windows</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_macos/>Installation for macOS</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-examples aria-expanded=false>
Examples</button><div class=collapse id=section-examples><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/examples/colliderbit_example/>ColliderBit Example</a></li><li><a class="docs-link rounded" href=/documentation/examples/anotherbit/>AnotherBit</a></li><li><a class="docs-link rounded" href=/documentation/examples/anotherbit2/>AnotherBit2</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-help aria-expanded=false>
Help</button><div class=collapse id=section-help><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/help/common_problems_and_questions/>Common Problems and Questions</a></li><li><a class="docs-link rounded" href=/documentation/help/compiler_matrix/>Compiler Matrix</a></li><li><a class="docs-link rounded" href=/documentation/help/known_issues/>Known Issues</a></li><li><a class="docs-link rounded" href=/documentation/help/configuration_examples/>Configuration Examples</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-code aria-expanded=false>
Code Reference</button><div class=collapse id=section-code><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/code/index_classes/>Classes</a></li><li><a class="docs-link rounded" href=/documentation/code/index_files/>Files</a></li><li><a class="docs-link rounded" href=/documentation/code/index_pages/>Pages</a></li><li><a class="docs-link rounded" href=/documentation/code/index_namespaces/>Namespaces</a></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#namespaces>Namespaces</a></li><li><a href=#source-code>Source code</a></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#namespaces>Namespaces</a></li><li><a href=#source-code>Source code</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/documentation/>Documentation</a></li><li class=breadcrumb-item><a href=/documentation/code/>Code Reference</a></li><li class="breadcrumb-item active" aria-current=page>file scripts/combine_hdf5.py</li></ol></nav><p class=lead></p><h1 id=file-scripts-combine-hdf5-py>file scripts/combine_hdf5.py</h1><p>[No description available]</p><h2 id=namespaces>Namespaces <a href=#namespaces class=anchor aria-hidden=true>#</a></h2><table><thead><tr><th>Name</th></tr></thead><tbody><tr><td><strong><a href=/documentation/code/namespaces/namespacecombine__hdf5/>combine_hdf5</a></strong></td></tr></tbody></table><h2 id=source-code>Source code <a href=#source-code class=anchor aria-hidden=true>#</a></h2><pre><code>#!/usr/bin/env python

&quot;&quot;&quot;Combine data from several hdf5 files created by HDF5Printer into a single file&quot;&quot;&quot;
import signal
def sigint_handler(signum, frame):
    print('CTRL+C is blocked while the HDF5Printer combine script runs! Signal received, but ignored.')
signal.signal(signal.SIGINT, sigint_handler)

from hdf5tools import *
import math
import numpy as np
import h5py
import os
import sys

chunksize = 1000

bufferlength = 100                # Must match setting in hdf5printer.hpp
max_ppidpairs = 10*bufferlength   #   &quot;  &quot;

def usage():
   print(&quot;  Usage: python combine_hdf5.py &lt;path-to-target-hdf5-file&gt; &lt;root group in hdf5 files&gt; &lt;tmp file 1&gt; &lt;tmp file 2&gt; ...&quot;)
   print()
   print(&quot;  Attempts to combine the data in a group of hdf5 files produced by HDF5Printer in separate processes during a GAMBIT run.&quot;)
   print(&quot;  Use --delete_tmp flag to delete input files upon successful combination.&quot;)
   print(&quot;  Use --runchecks flag to run some extra validity checks on the input and output data (warning: may be slow for large datasets)&quot;)
   exit(1)

#====Begin &quot;main&quot;=================================

#if len(sys.argv)!=6 and len(sys.argv)!=7: usage()
#
runchecks=False
delete_tmp=False
if len(sys.argv)&lt;3:
      usage()

# I dont think this works right...
if &quot;--runchecks&quot; in sys.argv:
  runchecks=True
  sys.argv.remove(&quot;--runchecks&quot;)

if &quot;--delete_tmp&quot; in sys.argv:
  delete_tmp=True
  sys.argv.remove(&quot;--delete_tmp&quot;)

outfname = sys.argv[1]
group = sys.argv[2]
tmp_files = sys.argv[3:]
N = len(tmp_files)
RA_group = group + &quot;/RA&quot;

print(&quot;Working directory: &quot;, (os.getcwd()))
print(&quot;Target combined filename:&quot;, outfname)
print(&quot;Root group: &quot;, group)
print(&quot;Number of files to combine: &quot;, N)
print(&quot;Files to combine: &quot;, tmp_files)
print(&quot;&quot;)
print(&quot;Analysing input files...&quot;)

files = {}

sync_dsets = [set([]) for i in range(N)]
RA_dsets = [set([]) for i in range(N)]
RA_dsets_exclude = set([&quot;RA_pointID&quot;,&quot;RA_pointID_isvalid&quot;,&quot;RA_MPIrank&quot;,&quot;RA_MPIrank_isvalid&quot;])
sync_lengths = [0 for i in range(N)]
RA_lengths = [0 for i in range(N)]
fnames = tmp_files

for i,fname in enumerate(fnames):
   print(&quot;   Opening: {0}&quot;.format(fname))
   f = h5py.File(fname,'r')
   files[fname] = f
   if runchecks:
      print(&quot;Checking temporary file for duplicates...&quot;)
      check_for_duplicates(f,group)
   print(&quot;      Analysing...&quot;)
   datasets = []
   tmp_dset_metadata = {}
   tmp_RA_dset_metadata = {}
   # First get total lengths of the sync datasets
   if group in f:
      get_dset_lengths(tmp_dset_metadata,f[group],sync_dsets[i])
      sync_lengths[i] = check_lengths(tmp_dset_metadata)
   else:
      raise ValueError(&quot;File '{0}' does not contain the group '{1}!'&quot;.format(fname,group))
   # Next get total lengths of the RA datasets
   if RA_group in f:
      get_dset_lengths(tmp_RA_dset_metadata,f[RA_group],RA_dsets[i])
      RA_lengths[i] = check_lengths(tmp_RA_dset_metadata)
   else:
      RA_lengths[i] = 0
      # No RA data in this file, but that's ok, it happens sometimes.
      #raise ValueError(&quot;File '{0}' does not contain the group '{1}!'&quot;.format(fname,RA_group))
   print(&quot;      ...done&quot;)

print(&quot;sync_lengths: &quot;, sync_lengths)
total_sync_length = sum(sync_lengths)

# Make sure all sync dsets have the same length

print(&quot;Sync dsets:&quot;)
for i,fname in enumerate(fnames):
   print(&quot; In {0}&quot;.format(fname))
   if len(sync_dsets[i])==0:
      print(&quot;   - None&quot;)
   else:
      for item in sorted(sync_dsets[i]):
         print(&quot;   - &quot;, item)
      print(&quot;   sync_length = {0}&quot;.format(sync_lengths[i]))

print(&quot;RA dsets:&quot;)
for i,fname in enumerate(fnames):
   print(&quot; In {0}&quot;.format(fname))
   if len(RA_dsets[i])==0:
      print(&quot;   - None&quot;)
   else:
      for item in sorted(RA_dsets[i]):
         print(&quot;   - &quot;, item)
      print(&quot;   RA_length = {0}&quot;.format(RA_lengths[i]))

print(&quot;Combined sync length = &quot;, total_sync_length)

print(&quot;Opening file for adding combined data:&quot;)
print(&quot;   {0}&quot;.format(outfname))
fout = h5py.File(outfname,'a')

if not group in fout:
   gout = fout.create_group(group)
else:
   if runchecks:
      print(&quot;Checking existing combined output for duplicates...&quot;)
      check_for_duplicates(fout,group)
   gout = fout[group]

# Check for existing dsets in the output (and get their lengths if they exist)
existing_dsets = {}
dsetlengths = {}
for name in gout:
   if isinstance(gout[name],h5py.Dataset):
      print(&quot;   Accessing existing dset:&quot;, name)
      existing_dsets[name] = gout[name]
      dsetlengths[name]   = gout[name].shape[0]

# check that the existing dsets have a consistent length
if len(dsetlengths)!=0:
   init_output_length = check_lengths(dsetlengths)
   print(&quot;Existing datasets have length &quot;, init_output_length)
else:
   init_output_length = 0


# Resize the existing dsets to accommodate the new data
for dsetname,dset in existing_dsets.items():
   print(&quot;   Extending existing dset '{0}' to length {1}+{2}={3} to accommodate new data...&quot;.format(dsetname,init_output_length,total_sync_length,init_output_length+total_sync_length))
   dset.resize((init_output_length+total_sync_length,))

# Create dataset to match every sync and RA dataset
target_dsets = {}
all_sync_dsets = set([]).union(*sync_dsets)
all_RA_dsets   = set([]).union(*RA_dsets)
for dsetname,dt in sorted(all_sync_dsets):
   if not dsetname in gout:
      print(&quot;   Creating empty dset:&quot;, dsetname)
      target_dsets[dsetname] = gout.create_dataset(dsetname, (init_output_length+total_sync_length,), chunks=(chunksize,), dtype=dt, maxshape=(None,))
   else:
      target_dsets[dsetname] = gout[dsetname]
for dsetname,dt in sorted(all_RA_dsets):
   if not dsetname in RA_dsets_exclude:
      if not dsetname in gout:
         print(&quot;   Creating empty dset:&quot;, dsetname)
         target_dsets[dsetname] = gout.create_dataset(dsetname, (init_output_length+total_sync_length,), chunks=(chunksize,), dtype=dt, maxshape=(None,))
      else:
         target_dsets[dsetname] = gout[dsetname]

# Copy data from separate sync datasets into combined datasets
nextempty=init_output_length
for fname in fnames:
   print(&quot;Copying sync data from file:&quot;)
   print(&quot;   {0}&quot;.format(fname))
   print(&quot;to file:&quot;)
   print(&quot;   {0}&quot;.format(outfname))
   fin = files[fname]

   if runchecks:
     print(&quot;Checking {0}[{1}] for duplicate entries&quot;.format(fname,group))
     check_for_duplicates(fin,group)
     print(&quot;No duplicates, proceeding with copy&quot;)

   dset_length=None
   for itemname in fin[group]:
      item = fin[group][itemname]
      if isinstance(item,h5py.Dataset):
        #print itemname,&quot;is a Dataset&quot;
         if dset_length==None:
            dset_length=item.shape[0]
         #Do the copy
         copy_dset_whole(item,gout[itemname],nextempty)
   if(dset_length==None):
      print(&quot;No sync dsets found! Nothing copied!&quot;)
   else:
      if runchecks:
         print(&quot;Re-checking combined file for duplicates...&quot;)
         check_for_duplicates(fout,group)
      nextempty+=dset_length

# Copy data from RA datasets into combined dataset
for fname in fnames:
   fin = files[fname]
   if RA_group in fin and &quot;RA_MPIrank&quot; in fin[RA_group]:
      print(&quot;RA data detected in file:&quot;)
      print(&quot;   {0}&quot;.format(fname))
      print(&quot;Copying it to file:&quot;)
      print(&quot;   {0}&quot;.format(outfname))

      # Get write targets
      dset_length=fin[RA_group][&quot;RA_MPIrank&quot;].shape[0]

      # Do this in chunks matching the max_ppidpairs value in hdf5printer.hpp
      nchunks = np.ceil(dset_length / (1.*max_ppidpairs))
      for i in range(int(nchunks)):
         imin = i*max_ppidpairs
         imax = np.min([(i+1)*max_ppidpairs, dset_length])

         pointIDs_in         = fin[RA_group][&quot;RA_pointID&quot;][imin:imax]
         mpiranks_in         = fin[RA_group][&quot;RA_MPIrank&quot;][imin:imax]
         pointIDs_isvalid_in = np.array(fin[RA_group][&quot;RA_pointID_isvalid&quot;][imin:imax],dtype=np.bool)
         mpiranks_isvalid_in = np.array(fin[RA_group][&quot;RA_MPIrank_isvalid&quot;][imin:imax],dtype=np.bool)

         mask_in = (pointIDs_isvalid_in &amp; mpiranks_isvalid_in)
         print(&quot;...{0} scheduled RA writes found.&quot;.format(np.sum(mask_in)))

         # convert entries to single values to facilitate fast comparison
         IDs_in = cantor_pairing(pointIDs_in[mask_in],mpiranks_in[mask_in])

         #if runchecks:
         #   print &quot;   checking input selection for duplicate keys...&quot;
         #   ids  = IDs_in
         #   pid  = pointIDs_in[mask_in]
         #   rank = mpiranks_in[mask_in]
         #   for ID,p,r in zip(ids,pid,rank):
         #      Nmatches = np.sum(ID==ids)
         #      if Nmatches&gt;1:
         #         print &quot;   Warning!&quot;, ID, &quot;is duplicated {0} times!&quot;.format(Nmatches)
         #         pMatch = np.sum(p==pid)
         #         rMatch = np.sum(r==rank)
         #         if pMatch&gt;1 or rMatch&gt;1:
         #           print &quot;   ...pointID duplicate count: &quot;, pMatch
         #           print &quot;   ...MPIrank duplicate count: &quot;, rMatch

         # Find them in the target output file
         # TODO: this part could still cause memory issues if the output datasets are too big
         pointIDs_out         = fout[group][&quot;pointID&quot;]
         mpiranks_out         = fout[group][&quot;MPIrank&quot;]
         pointIDs_isvalid_out = np.array(fout[group][&quot;pointID_isvalid&quot;][:],dtype=np.bool)
         mpiranks_isvalid_out = np.array(fout[group][&quot;MPIrank_isvalid&quot;][:],dtype=np.bool)

         mask_out = (pointIDs_isvalid_out &amp; mpiranks_isvalid_out)
         print(&quot;...{0} possible RA targets found.&quot;.format(np.sum(mask_out)))

         # convert entries to single values to facilitate fast comparison
         IDs_out = cantor_pairing(
                     np.array(pointIDs_out[mask_out],dtype=np.longlong),
                     np.array(mpiranks_out[mask_out],dtype=np.longlong)
                     )
         # check that the pairing has not overflowed
         if np.any(IDs_out&lt;0):
            raise ValueError(&quot;Error while computing cantor pairing for RA to SYNC matching! Integer overflow detected, so matching will fail! Please increase the size of the integer type used!&quot;)

         if runchecks:
            print(&quot;   checking output selection for duplicate keys...&quot;)
            ids  = IDs_out
            pid  = pointIDs_out[mask_out]
            rank = mpiranks_out[mask_out]
            for ID,p,r in zip(ids,pid,rank):
               Nmatches = np.sum(ID==ids)
               if Nmatches&gt;1:
                  print(&quot;   Warning!&quot;, ID, &quot;is duplicated {0} times!&quot;.format(Nmatches))
                  Match = np.sum((p==pid) &amp; (r==rank))
                  if Match&gt;1:
                    print(&quot;   ...MPIrank/pointID duplicate count: &quot;, Match)

         # Find which IDs in the output dataset are write targets
         target_mask_small = np.in1d(IDs_out,IDs_in)

         # Cast the mask back so that it works on the original dataset
         # (TODO: is there a more efficient way to do this? &quot;target_mask[mask_out][target_mask_small] = True&quot; does not work.)
         target_length = fout[group][&quot;pointID&quot;].shape[0]
         alltargetindices = np.arange(target_length)
         maskindices = alltargetindices[mask_out][target_mask_small]

         target_mask = np.zeros(target_length, dtype=bool)
         target_mask[maskindices] = True

         if runchecks:
            print(&quot;   Double-checking that all selected input dset entries have matching targets in the output dsets...&quot;)
            for ID,pid,rank in zip(IDs_in,pointIDs_in[mask_in],mpiranks_in[mask_in]):
               if ID not in IDs_out: #[target_mask_small]:
                  print(&quot;   Warning! No target for ID {0} found in output selection! ({1},{2})&quot;.format(ID,pid,rank))
                  indexid = np.where( (np.array(IDs_out)==ID) )
                  index   = np.where( (np.array(pointIDs_out[mask_out])==pid) &amp;
                                      (np.array(mpiranks_out[mask_out])==rank) )
                  print(&quot;index of match by ID       = &quot;, indexid)
                  print(&quot;index of match by pid,rank = &quot;, index)
                  print(&quot;pid,rank =&quot;,pid,rank)
                  print(&quot;pointID? &quot;, pointIDs_out[mask_out][index])
                  print(&quot;valid? &quot;,   pointIDs_isvalid_out[mask_out][index])
                  print(&quot;rank? &quot;,  mpiranks_out[mask_out][index])
                  print(&quot;valid? &quot;, mpiranks_isvalid_out[mask_out][index])
                  print(&quot;cantor =&quot;, cantor_pairing(pid,rank))
                  print(&quot;cantor==ID? &quot;, cantor_pairing(pid,rank)==ID)


         # Number of &quot;true&quot; elements in target mask should match number of elements in 'in' arrays (after masking)
         # Check this
         ntargets = np.sum(target_mask)
         nsources = np.sum(mask_in)
         if ntargets!=nsources:
            raise ValueError(&quot;Error while computing targets for RA writes! Number of target matches for writes in the output dataset ({0}) does not match the number of elements scheduled for copying {1}!&quot;.format(ntargets,nsources))

         ## Just some test code which I decided to keep around since it is helpful
         ## for understand how the rearrangment of the input data to match the output
         ## selection works.
         ##
         ## \code
         ## # Compute sorting index array for rearranging the source entries to match the target locations
         ## # The way this works is a bit trippy, but it is fast.
         ## #y = target (IDs_out)
         ## #x = sources (IDs_in)
         ## #result = array of length(y), containing positions of
         ## #e.g.
         ## #x = np.array([3,5,7,1 ,9  ,8,6,6])
         ## #y = np.array([2,1,5,10,100,6])
         ## # out = [ - 3 1 - - 6 ]
         ## # i.e. &quot;1&quot; in y, is in position index 3 of x.
         ## x1 = np.array([0,1,2,3,4,5,6,7,8])
         ## y1 = np.array([4,3,5,0,1,2,6,8,7])
         ## # where in x is each element of y?
         ## # should give back y, since e.g. 4 is at index 4 in x
         ## # then using ypos as indices on x[sort1], should again return y.
         ## xsort1 = np.argsort(x1)
         ## ypos1 = np.searchsorted(x1[xsort1], y1)
         ## print &quot;verifying...&quot;
         ## print y1
         ## print ypos1
         ## print xsort1[ypos1]
         ## # less trivial test:
         ## x2 = np.array([0,1,7,2,7,8,6,4])
         ## y2 = np.array([4,0,1,2,6,8,7])
         ## # indices array should be:
         ## #            [8,1,2,3,7,5,2]
         ## # (but in our case we don't want duplicates in either the target or input arrays!)
         ## xsort2 = np.argsort(x2)
         ## ypos2 = np.searchsorted(x2[xsort2], y2)
         ## indices = xsort2[ypos2]
         ## print &quot;verifying...&quot;
         ## print x2
         ## print xsort2
         ## print x2[xsort2]
         ## print &quot;y2&quot;
         ## print y2
         ## print ypos2
         ## print indices
         ## print x2[indices]
         ## \endcode

         print(&quot;   Sorting input data to match order in output selection...&quot;)
         xsort = np.argsort(IDs_in)
         yindex = np.searchsorted(IDs_in[xsort], IDs_out[target_mask_small])
         fancyindices = xsort[yindex]

         if runchecks:
            print(&quot;   Checking that matching of input data to output selection has succeeded...&quot;)
            print(yindex[:10])
            for k,(i,j) in enumerate(zip(IDs_out[target_mask_small][:100],IDs_in[fancyindices[:100]])):
              if i!=j:
                print(&quot;   Warning! Mismatch found. At position {0}, input ID ({1}) != output ID ({2})&quot;.format(k,i,j))
                #print i,j
                #print IDs_out[k-1:k+2]
                #print IDs_in[fancyindices[k-1:k+2]]
                #print &quot;pids and ranks:&quot;
                #print pointIDs_in[mask_in][fancyindices[k-1:k+2]]
                #print mpiranks_in[mask_in][fancyindices[k-1:k+2]]

         # Copy the data from the source to the target, after first
         # rearraging the source according to the index array we just created
         for itemname in fin[RA_group]:
            item = fin[RA_group][itemname]
            if isinstance(item,h5py.Dataset) and not itemname in RA_dsets_exclude:
               #Do the copy
               indset = item[imin:imax]
               #(TODO: figure out how to chunk this...)
               outdset = fout[group][itemname]
               #Check that types match
               if indset.dtype!=outdset.dtype:
                  raise ValueError(&quot;Type mismatch detected between dataset {0} in file {1} (dtype={2}), and matching dataset in output file {3} (dtype={3})&quot;.format(itemname,fname,indset.dtype,outfname,outdset.dtype))
               #can't do the fancy list-indexing directly on the hdf5 dataset (the boolean assignment should be ok though)
               print(&quot;   Copying RA data for dataset&quot;, itemname)
               outdset[target_mask] = indset[mask_in][fancyindices]

# DEBUGGING
# Check for duplicates in combined output
if runchecks:
   print(&quot;Checking final combined output for duplicates...&quot;)
   check_for_duplicates(fout,group)

# If everything has been successful, delete the temporary files
if delete_tmp:
   print(&quot;Deleting temporary HDF5 files...&quot;)
   for fname in fnames:
      print(&quot;   {0}&quot;.format(fname))
      os.remove(fname)

print(&quot;Data combination completed&quot;)
</code></pre><hr><p>Updated on 2022-09-08 at 01:05:20 +0000</p></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=/license/>License</a></li></ul></div></div></div></footer><script src=/js/bootstrap.min.1da7e648bd316d7b1f1bff21fe81545e73f3c2385908a8c3be87f79a560042318b4b13031e53871d84590710da0df312590e0c60b11a6a1b83dede2f81c30b66.js integrity="sha512-HafmSL0xbXsfG/8h/oFUXnPzwjhZCKjDvof3mlYAQjGLSxMDHlOHHYRZBxDaDfMSWQ4MYLEaahuD3t4vgcMLZg==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.5b48bc253dc75aeea5fb366ecf700f4925e2b6eb1a1466f2124b722d68148d67bc0a9365d2b8ad9c585161b46372d23b08509a16f1fd518542b894756d4752d0.js integrity="sha512-W0i8JT3HWu6l+zZuz3APSSXitusaFGbyEktyLWgUjWe8CpNl0ritnFhRYbRjctI7CFCaFvH9UYVCuJR1bUdS0A==" crossorigin=anonymous defer></script>
<script src=/main.min.162c56a0426544de0d010e66c56e321579655c400c9aae06a6823e7682de379adadf2165bd416fea191e4e7e410fbf1fd2c35a759aa43ff2e3787067669bf81b.js integrity="sha512-FixWoEJlRN4NAQ5mxW4yFXllXEAMmq4GpoI+doLeN5ra3yFlvUFv6hkeTn5BD78f0sNadZqkP/LjeHBnZpv4Gw==" crossorigin=anonymous defer></script>
<script src=https://gambitbsm.github.io/index.min.f61c4089016d42091d600ab8235135d4c5a64f3bb5efc4b24a62043c6d899a72ff85ca598f1c928bdf8274e762e1862582767b5a0865c552d4d07add7553fa31.js integrity="sha512-9hxAiQFtQgkdYAq4I1E11MWmTzu178SySmIEPG2JmnL/hcpZjxySi9+CdOdi4YYlgnZ7WghlxVLU0HrddVP6MQ==" crossorigin=anonymous defer></script></body></html>