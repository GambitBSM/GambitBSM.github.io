<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://gambitbsm.org/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://gambitbsm.org/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://gambitbsm.org/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var e=localStorage.getItem("theme");e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://gambitbsm.org/main.e0ef67572fa591316dbb2b276e1aed52fd04025355d700a37b20ae76eb126fadbe7ceaddbb47632a2f1bf66c490a69e0cd1f1a0dc12b2980ae4b5ffc6d257d62.css integrity="sha512-4O9nVy+lkTFtuysnbhrtUv0EAlNV1wCjeyCudusSb62+fOrdu0djKi8b9mxJCmngzR8aDcErKYCuS1/8bSV9Yg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>file src/DirectDetection.cpp - GAMBIT</title><meta name=description content="[No description available]"><link rel=canonical href=https://gambitbsm.org/documentation/code/files/directdetection_8cpp/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="file src/DirectDetection.cpp"><meta property="og:description" content="[No description available]"><meta property="og:url" content="https://gambitbsm.org/documentation/code/files/directdetection_8cpp/"><meta property="og:site_name" content="GAMBIT"><meta property="og:image" content="https://gambitbsm.org/gambit_logo.png"><meta property="og:image:alt" content="GAMBIT"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="file src/DirectDetection.cpp"><meta name=twitter:description content="[No description available]"><meta name=twitter:image content="https://gambitbsm.org/gambit_logo.png"><meta name=twitter:image:alt content="file src/DirectDetection.cpp"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://gambitbsm.org/#/schema/organization/1","name":"Doks","url":"https://gambitbsm.org/","sameAs":["https://github.com/GambitBSM"],"logo":{"@type":"ImageObject","@id":"https://gambitbsm.org/#/schema/image/1","url":"https://gambitbsm.org/logo-doks.png","width":450,"height":416,"caption":"Doks"},"image":{"@id":"https://gambitbsm.org/#/schema/image/1"}},{"@type":"WebSite","@id":"https://gambitbsm.org/#/schema/website/1","url":"https://gambitbsm.org/","name":"GAMBIT","description":"Documentation for GAMBIT, the Global And Modular BSM Inference Tool","publisher":{"@id":"https://gambitbsm.org/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://gambitbsm.org/documentation/code/files/directdetection_8cpp/","url":"https://gambitbsm.org/documentation/code/files/directdetection_8cpp/","name":"file src\/DirectDetection.cpp","description":"[No description available]","isPartOf":{"@id":"https://gambitbsm.org/#/schema/website/1"},"about":{"@id":"https://gambitbsm.org/#/schema/organization/1"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"0001-01-01T00:00:00CET","breadcrumb":{"@id":"https://gambitbsm.org/documentation/code/files/directdetection_8cpp/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://gambitbsm.org/documentation/code/files/directdetection_8cpp/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://gambitbsm.org/documentation/code/files/directdetection_8cpp/"]}]},{"@type":"BreadcrumbList","@id":"https://gambitbsm.org/documentation/code/files/directdetection_8cpp/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://gambitbsm.org/","url":"https://gambitbsm.org/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://gambitbsm.org/documentation/","url":"https://gambitbsm.org/documentation/","name":"Documentation"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://gambitbsm.org/documentation/code/","url":"https://gambitbsm.org/documentation/code/","name":"Code"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"https://gambitbsm.org/documentation/code/files/","url":"https://gambitbsm.org/documentation/code/files/","name":"Files"}},{"@type":"ListItem","position":5,"item":{"@id":"https://gambitbsm.org/documentation/code/files/directdetection_8cpp/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://gambitbsm.org/documentation/code/files/directdetection_8cpp/#/schema/image/2","url":"https://gambitbsm.org/gambit_logo.png","contentUrl":"https://gambitbsm.org/gambit_logo.png","caption":"file src\/DirectDetection.cpp"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://gambitbsm.org/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://gambitbsm.org/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://gambitbsm.org/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://gambitbsm.org/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gambitbsm.org/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gambitbsm.org/site.webmanifest></head><body class="documentation single light"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=https://gambitbsm.org/ aria-label=GAMBIT><img class=logo-light src=https://gambitbsm.org/gambit_logo.png width=50px>
<img class="logo-dark d-none" src=https://gambitbsm.org/gambit_logo.png width=50px>
GAMBIT</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>GAMBIT</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Releases
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.6>GAMBIT 2-6 ⧉</a></li><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.5>GAMBIT 2-5 ⧉</a></li><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.4>GAMBIT 2-4 ⧉</a></li><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.3>GAMBIT 2-3 ⧉</a></li><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.2>GAMBIT 2-2 ⧉</a></li><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.1>GAMBIT 2-1 ⧉</a></li><li><a class=dropdown-item href=https://github.com/GambitBSM/gambit_2.6/tags>All releases ⧉</a></li></ul></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Documentation
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=/documentation/installation/introduction/>Installation</a></li><li><a class=dropdown-item href=/documentation/tutorials/the_gambit_interface>Tutorials</a></li><li><a class=dropdown-item href=/documentation/help/common_problems_and_questions/>Help</a></li><li><a class=dropdown-item href=/documentation/code/index_classes>Code Reference</a></li></ul></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Community
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://github.com/GambitBSM/wiki>Wiki</a></li><li><a class=dropdown-item href=/community/publications/>Publications</a></li><li><a class=dropdown-item href=/community/talks/>Talks</a></li><li><a class=dropdown-item href=/community/members/>Members</a></li><li><a class=dropdown-item href=/community/code_of_conduct/>Code of Conduct</a></li><li><a class=dropdown-item href=/community/contact/>Contact</a></li></ul></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search site..." aria-label="Search site..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/GambitBSM><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-installation aria-expanded=false>
Installation</button><div class=collapse id=section-installation><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/installation/introduction/>Getting Started</a></li><li><a class="docs-link rounded" href=/documentation/installation/docker_usage/>Docker Usage</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_linux/>Installation for Linux</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_windows/>Installation for Windows</a></li><li><a class="docs-link rounded" href=/documentation/installation/installation_for_macos/>Installation for macOS</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-tutorials aria-expanded=false>
Tutorials</button><div class=collapse id=section-tutorials><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/tutorials/the_gambit_interface/>1 - The GAMBIT Interface</a></li><li><a class="docs-link rounded" href=/documentation/tutorials/in_person_tutorials/>In person tutorials</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-help aria-expanded=false>
Help</button><div class=collapse id=section-help><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/help/common_problems_and_questions/>Common Problems and Questions</a></li><li><a class="docs-link rounded" href=/documentation/help/compiler_matrix/>Compiler Matrix</a></li><li><a class="docs-link rounded" href=/documentation/help/known_issues/>Known Issues</a></li><li><a class="docs-link rounded" href=/documentation/help/configuration_examples/>Configuration Examples</a></li><li><a class="docs-link rounded" href=/documentation/help/support/>Support</a></li></ul></div></li><li class=mb-1><button class="btn btn-toggle align-items-center rounded collapsed" data-bs-toggle=collapse data-bs-target=#section-code aria-expanded=false>
Code Reference</button><div class=collapse id=section-code><ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small"><li><a class="docs-link rounded" href=/documentation/code/index_classes/>Classes</a></li><li><a class="docs-link rounded" href=/documentation/code/index_files/>Files</a></li><li><a class="docs-link rounded" href=/documentation/code/index_pages/>Pages</a></li><li><a class="docs-link rounded" href=/documentation/code/index_namespaces/>Namespaces</a></li></ul></div></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#namespaces>Namespaces</a></li><li><a href=#defines>Defines</a></li><li><a href=#detailed-description>Detailed Description</a></li><li><a href=#macros-documentation>Macros Documentation</a><ul><li><a href=#define-ddcalc-result>define DDCALC_RESULT</a></li><li><a href=#define-ddcalc-bin>define DDCALC_BIN</a></li><li><a href=#define-dd-ex>define DD_EX</a></li></ul></li><li><a href=#source-code>Source code</a></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#namespaces>Namespaces</a></li><li><a href=#defines>Defines</a></li><li><a href=#detailed-description>Detailed Description</a></li><li><a href=#macros-documentation>Macros Documentation</a><ul><li><a href=#define-ddcalc-result>define DDCALC_RESULT</a></li><li><a href=#define-ddcalc-bin>define DDCALC_BIN</a></li><li><a href=#define-dd-ex>define DD_EX</a></li></ul></li><li><a href=#source-code>Source code</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/documentation/>Documentation</a></li><li class=breadcrumb-item><a href=/documentation/code/>Code Reference</a></li><li class="breadcrumb-item active" aria-current=page>file src/DirectDetection.cpp</li></ol></nav><p class=lead></p><h1 id=file-src-directdetection-cpp>file src/DirectDetection.cpp <a href=#file-src-directdetection-cpp class=anchor aria-hidden=true>#</a></h1><p>[No description available] <a href=#detailed-description>More&mldr;</a></p><h2 id=namespaces>Namespaces <a href=#namespaces class=anchor aria-hidden=true>#</a></h2><table><thead><tr><th>Name</th></tr></thead><tbody><tr><td><strong><a href=/documentation/code/namespaces/namespacegambit/>Gambit</a></strong><br>TODO: see if we can use this one:</td></tr><tr><td><strong><a href=/documentation/code/namespaces/namespacegambit_1_1darkbit/>Gambit::DarkBit</a></strong></td></tr></tbody></table><h2 id=defines>Defines <a href=#defines class=anchor aria-hidden=true>#</a></h2><table><thead><tr><th></th><th>Name</th></tr></thead><tbody><tr><td></td><td><strong><a href=/documentation/code/files/directdetection_8cpp/#define-ddcalc-result>DDCALC_RESULT</a></strong>(EXPERIMENT, TYPE, NAME)<br>Defines a prototypical DDCalc result extractor.</td></tr><tr><td></td><td><strong><a href=/documentation/code/files/directdetection_8cpp/#define-ddcalc-bin>DDCALC_BIN</a></strong>(EXPERIMENT, TYPE, NAME)</td></tr><tr><td></td><td><strong><a href=/documentation/code/files/directdetection_8cpp/#define-dd-ex>DD_EX</a></strong>(EXPERIMENT)</td></tr></tbody></table><h2 id=detailed-description>Detailed Description <a href=#detailed-description class=anchor aria-hidden=true>#</a></h2><p><strong>Author</strong>:</p><ul><li>Christopher Savage (<a href=mailto:chris@savage.name>chris@savage.name</a>)</li><li>Jonathan Cornell (<a href=mailto:jcornell@ucsc.edu>jcornell@ucsc.edu</a>)</li><li>Felix Kahlhoefer (<a href=mailto:felix.kahlhoefer@desy.de>felix.kahlhoefer@desy.de</a>)</li><li>Pat Scott (<a href=mailto:p.scott@imperial.ac.uk>p.scott@imperial.ac.uk</a>)</li><li>Sebastian Wild (<a href=mailto:sebastian.wild@desy.de>sebastian.wild@desy.de</a>)</li><li>Ankit Beniwal (<a href=mailto:ankit.beniwal@adelaide.edu.au>ankit.beniwal@adelaide.edu.au</a>)</li><li>Torsten Bringmann (<a href=mailto:torsten.bringmann@fys.uio.no>torsten.bringmann@fys.uio.no</a>)</li><li>Sanjay Bloor (<a href=mailto:sanjay.bloor12@imperial.ac.uk>sanjay.bloor12@imperial.ac.uk</a>)</li><li>Timon Emken (<a href=mailto:timon.emken@fysik.su.se>timon.emken@fysik.su.se</a>)</li><li>Tomas Gonzalo (<a href=mailto:tomas.gonzalo@kit.edu>tomas.gonzalo@kit.edu</a>)</li></ul><p><strong>Date</strong>:</p><ul><li>2014 Oct</li><li>2015 Jan, Feb, June</li><li>2015 Mar</li><li>2016 August</li><li>2015–2018</li><li>2017 October, November</li><li>2018 August</li><li>2019 May</li><li>2018 Sep</li><li>2020 Feb</li><li>2022 April</li><li>2023 June</li></ul><p>Routines for direct detection couplings and likelihoods.</p><hr><p>Authors (add name and date if you modify):</p><hr><h2 id=macros-documentation>Macros Documentation <a href=#macros-documentation class=anchor aria-hidden=true>#</a></h2><h3 id=define-ddcalc-result>define DDCALC_RESULT <a href=#define-ddcalc-result class=anchor aria-hidden=true>#</a></h3><pre><code>#define DDCALC_RESULT(
    EXPERIMENT,
    TYPE,
    NAME
)
    void CAT_3(EXPERIMENT,_Get,NAME)(TYPE &amp;result)                                 \
    {                                                                              \
      using namespace Pipes::CAT_3(EXPERIMENT,_Get,NAME);                          \
      TYPE temp_result = BEreq::CAT(DD_,NAME)(BEreq::DD_Experiment(STRINGIFY(EXPERIMENT)));  \
      if (Utils::isnan(temp_result))                                               \
      {                                                                            \
        /* DarkBit_error().raise(LOCAL_INFO, &quot;Got NaN value from DDCalc.&quot;); */     \
        /* TODO: Raise a proper error here -- NaNs should be fixed. */             \
        invalid_point().raise(&quot;Got NaN value from DDCalc! This need fixing!&quot;);     \
      }                                                                            \
      result = temp_result;                                                        \
    }
</code></pre><p>Defines a prototypical DDCalc result extractor.</p><h3 id=define-ddcalc-bin>define DDCALC_BIN <a href=#define-ddcalc-bin class=anchor aria-hidden=true>#</a></h3><pre><code>#define DDCALC_BIN(
    EXPERIMENT,
    TYPE,
    NAME
)
    void CAT_3(EXPERIMENT,_GetBin,NAME)(std::vector&lt;double&gt; &amp;result)               \
    {                                                                              \
      using namespace Pipes::CAT_3(EXPERIMENT,_GetBin,NAME);                       \
      result.clear();                                                              \
      int nbins;                                                                   \
      nbins = BEreq::DD_Bins(BEreq::DD_Experiment(STRINGIFY(EXPERIMENT)));         \
      for (int ibin=1;ibin&lt;=nbins;ibin++) {                                        \
        result.push_back(                                                          \
        BEreq::CAT(DD_Bin,NAME)(BEreq::DD_Experiment(STRINGIFY(EXPERIMENT)),ibin)); } \
    }
</code></pre><h3 id=define-dd-ex>define DD_EX <a href=#define-dd-ex class=anchor aria-hidden=true>#</a></h3><pre><code>#define DD_EX(
    EXPERIMENT
)
      /* Calculations */                                                           \
      void CAT(EXPERIMENT,_Calc)(bool &amp;result)                                     \
      {                                                                            \
        using namespace Pipes::CAT(EXPERIMENT,_Calc);                              \
        BEreq::DD_CalcRates(BEreq::DD_Experiment(STRINGIFY(EXPERIMENT)));          \
        result = true;                                                             \
      }                                                                            \
      /* Results */                                                                \
      DDCALC_RESULT(EXPERIMENT, int,    Events)                                    \
      DDCALC_RESULT(EXPERIMENT, double, Background)                                \
      DDCALC_RESULT(EXPERIMENT, double, Signal)                                    \
      DDCALC_RESULT(EXPERIMENT, double, SignalSI)                                  \
      DDCALC_RESULT(EXPERIMENT, double, SignalSD)                                  \
      DDCALC_RESULT(EXPERIMENT, int,    Bins)                                      \
      DDCALC_RESULT(EXPERIMENT, double, LogLikelihood)                             \
      DDCALC_BIN(EXPERIMENT, int,    Events)                                       \
      DDCALC_BIN(EXPERIMENT, double, Background)                                   \
      DDCALC_BIN(EXPERIMENT, double, Signal)                                       \
</code></pre><p>Defines functions to perform the DDCalc internal rate calculations, and extract the results and log likelihoods, for the designated experiment.</p><h2 id=source-code>Source code <a href=#source-code class=anchor aria-hidden=true>#</a></h2><pre><code>//   GAMBIT: Global and Modular BSM Inference Tool
//   *********************************************
///  \file
///
///  Routines for direct detection couplings and
///  likelihoods.
///
///  *********************************************
///
///  Authors (add name and date if you modify):
///
///  \author Christopher Savage
///          (chris@savage.name)
///  \date 2014 Oct
///  \date 2015 Jan, Feb, June
///
///  \author Jonathan Cornell
///          (jcornell@ucsc.edu)
///  \date 2015 Mar
///
///  \author Felix Kahlhoefer
///          (felix.kahlhoefer@desy.de)
///  \date 2016 August
///
///  \author Pat Scott
///          (p.scott@imperial.ac.uk)
///  \date 2015--2018
///
///  \author Sebastian Wild
///          (sebastian.wild@desy.de)
///  \date 2017 October, November
///
///  \author Ankit Beniwal
///          (ankit.beniwal@adelaide.edu.au)
///  \date 2018 August
///
///  \author Torsten Bringmann
///          (torsten.bringmann@fys.uio.no)
///  \date 2019 May
///
///  \author Sanjay Bloor
///          (sanjay.bloor12@imperial.ac.uk)
///  \date 2018 Sep
///  \date 2020 Feb
///
///  \author Timon Emken
///          (timon.emken@fysik.su.se)
///  \date 2022 April
///
///  \author Tomas Gonzalo
///          (tomas.gonzalo@kit.edu)
///  \date 2023 June
///
///  *********************************************

#include &quot;gambit/Elements/gambit_module_headers.hpp&quot;
#include &quot;gambit/DarkBit/DarkBit_rollcall.hpp&quot;

namespace Gambit
{
  namespace DarkBit
  {

    //////////////////////////////////////////////////////////////////////////
    //
    //                 Direct detection couplings
    //
    //////////////////////////////////////////////////////////////////////////

    /*! \brief Get direct detection couplings from initialized DarkSUSY 5.
    */
    void DD_couplings_DarkSUSY_DS5(DM_nucleon_couplings &amp;result)
    {
      using namespace Pipes::DD_couplings_DarkSUSY_DS5;

      double fG;

      // Set proton hadronic matrix elements
      BEreq::ddcom-&gt;ftp(7)  = *Param[&quot;fpu&quot;];
      BEreq::ddcom-&gt;ftp(8)  = *Param[&quot;fpd&quot;];
      BEreq::ddcom-&gt;ftp(10) = *Param[&quot;fps&quot;];

      fG = 2./27.*(1. - *Param[&quot;fpu&quot;] - *Param[&quot;fpd&quot;] - *Param[&quot;fps&quot;]);
      BEreq::ddcom-&gt;ftp(9) = fG;
      BEreq::ddcom-&gt;ftp(11) = fG;
      BEreq::ddcom-&gt;ftp(12) = fG;

      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;DarkSUSY proton hadronic matrix elements set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ftp(7) = fpu = &quot; &lt;&lt; BEreq::ddcom-&gt;ftp(7);
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tftp(8) = fpd = &quot; &lt;&lt; BEreq::ddcom-&gt;ftp(8);
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tftp(10) = fps = &quot; &lt;&lt; BEreq::ddcom-&gt;ftp(10) &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ftp(9) = ftp(11) = ftp(12) = 2/27 fG = &quot; &lt;&lt;
        BEreq::ddcom-&gt;ftp(9) &lt;&lt; EOM;

      // Set neutron hadronic matrix elements
      BEreq::ddcom-&gt;ftn(7)  = *Param[&quot;fnu&quot;];
      BEreq::ddcom-&gt;ftn(8)  = *Param[&quot;fnd&quot;];
      BEreq::ddcom-&gt;ftn(10) = *Param[&quot;fns&quot;];

      fG = 2./27.*(1. - *Param[&quot;fnu&quot;] - *Param[&quot;fnd&quot;] - *Param[&quot;fns&quot;]);
      BEreq::ddcom-&gt;ftn(9) = fG;
      BEreq::ddcom-&gt;ftn(11) = fG;
      BEreq::ddcom-&gt;ftn(12) = fG;

      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;DarkSUSY neutron hadronic matrix elements set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ftn(7) = fnu = &quot; &lt;&lt; BEreq::ddcom-&gt;ftn(7);
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tftn(8) = fnd = &quot; &lt;&lt; BEreq::ddcom-&gt;ftn(8);
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tftn(10) = fns = &quot; &lt;&lt; BEreq::ddcom-&gt;ftn(10) &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ftn(9) = ftn(11) = ftn(12) = 2/27 fG = &quot; &lt;&lt;
        BEreq::ddcom-&gt;ftn(9) &lt;&lt; EOM;

      // Set deltaq
      BEreq::ddcom-&gt;delu = *Param[&quot;deltau&quot;];
      BEreq::ddcom-&gt;deld = *Param[&quot;deltad&quot;];
      BEreq::ddcom-&gt;dels = *Param[&quot;deltas&quot;];
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;DarkSUSY delta q set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;delu = delta u = &quot; &lt;&lt; BEreq::ddcom-&gt;delu;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tdeld = delta d = &quot; &lt;&lt; BEreq::ddcom-&gt;deld;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tdels = delta s = &quot; &lt;&lt; BEreq::ddcom-&gt;dels &lt;&lt; EOM;


      // Loop corrections and pole removal.

      // Option loop&lt;bool&gt;: If true, include 1-loop effects discussed in
      // Drees Nojiri Phys.Rev. D48 (1993) 3483-3501 (default: true)
      BEreq::ddcom-&gt;dddn = runOptions-&gt;getValueOrDef&lt;bool&gt;(true,&quot;loop&quot;);

      // Option pole&lt;bool&gt;: If true, include pole in nuclear scattering cross-section.
      // If false, approximate squark propagator as 1/m_sq^2 (default: false)
      BEreq::ddcom-&gt;ddpole = runOptions-&gt;getValueOrDef&lt;bool&gt;(false,&quot;pole&quot;);

      // Some version notes:
      // The default in DS5 is to for both these options to be false (tree-level cross-section with pole removed).
      // The default in DS6 is to use Drees-Nojiri (1 loop) with the pole removed, which isn't an
      // option in the official DS5.1.3.  The version in GAMBIT is patched to implement this option though,
      // so we use it as the default here.

      // Calling DarkSUSY subroutine dsddgpgn(gps,gns,gpa,gna)
      // to set all four couplings.
      std::vector&lt;double&gt; DDcouplings=BEreq::get_DD_couplings();
      double factor =
      /// Option rescale_couplings&lt;double&gt;: Rescaling factor for WIMP-nucleon couplings (default 1.)
      runOptions-&gt;getValueOrDef&lt;double&gt;(1., &quot;rescale_couplings&quot;);
      result.gps = factor*DDcouplings[0];// *= factor;
      result.gns = factor*DDcouplings[1];// *= factor;
      result.gpa = factor*DDcouplings[2];// *= factor;
      result.gna = factor*DDcouplings[3];// *= factor;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;DarkSUSY dsddgpgn gives:&quot; &lt;&lt; std::endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gps = &quot; &lt;&lt; result.gps &lt;&lt; std::endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gns = &quot; &lt;&lt; result.gns &lt;&lt; std::endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gpa = &quot; &lt;&lt; result.gpa &lt;&lt; std::endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gna = &quot; &lt;&lt; result.gna &lt;&lt; EOM;
    }

    /*! \brief Get direct detection couplings from DarkSUSY 6 initialized with MSSM module.
    */
    void DD_couplings_DarkSUSY_MSSM(DM_nucleon_couplings &amp;result)
    {
      using namespace Pipes::DD_couplings_DarkSUSY_MSSM;

      double fG;

      // Set proton hadronic matrix elements
      BEreq::ddcomlegacy-&gt;ftp(7)  = *Param[&quot;fpu&quot;];
      BEreq::ddcomlegacy-&gt;ftp(8)  = *Param[&quot;fpd&quot;];
      BEreq::ddcomlegacy-&gt;ftp(10) = *Param[&quot;fps&quot;];

      fG = 2./27.*(1. - *Param[&quot;fpu&quot;] - *Param[&quot;fpd&quot;] - *Param[&quot;fps&quot;]);
      BEreq::ddcomlegacy-&gt;ftp(9) = fG;
      BEreq::ddcomlegacy-&gt;ftp(11) = fG;
      BEreq::ddcomlegacy-&gt;ftp(12) = fG;

      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;DarkSUSY proton hadronic matrix elements set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ftp(7) = fpu = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;ftp(7);
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tftp(8) = fpd = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;ftp(8);
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tftp(10) = fps = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;ftp(10) &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ftp(9) = ftp(11) = ftp(12) = 2/27 fG = &quot; &lt;&lt;
        BEreq::ddcomlegacy-&gt;ftp(9) &lt;&lt; EOM;

      // Set neutron hadronic matrix elements
      BEreq::ddcomlegacy-&gt;ftn(7)  = *Param[&quot;fnu&quot;];
      BEreq::ddcomlegacy-&gt;ftn(8)  = *Param[&quot;fnd&quot;];
      BEreq::ddcomlegacy-&gt;ftn(10) = *Param[&quot;fns&quot;];

      fG = 2./27.*(1. - *Param[&quot;fnu&quot;] - *Param[&quot;fnd&quot;] - *Param[&quot;fns&quot;]);
      BEreq::ddcomlegacy-&gt;ftn(9) = fG;
      BEreq::ddcomlegacy-&gt;ftn(11) = fG;
      BEreq::ddcomlegacy-&gt;ftn(12) = fG;

      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;DarkSUSY neutron hadronic matrix elements set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ftn(7) = fnu = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;ftn(7);
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tftn(8) = fnd = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;ftn(8);
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tftn(10) = fns = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;ftn(10) &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ftn(9) = ftn(11) = ftn(12) = 2/27 fG = &quot; &lt;&lt;
        BEreq::ddcomlegacy-&gt;ftn(9) &lt;&lt; EOM;

      // Set deltaq
      BEreq::ddcomlegacy-&gt;delu = *Param[&quot;deltau&quot;];
      BEreq::ddcomlegacy-&gt;deld = *Param[&quot;deltad&quot;];
      BEreq::ddcomlegacy-&gt;dels = *Param[&quot;deltas&quot;];
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;DarkSUSY delta q set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;delu = delta u = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;delu;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tdeld = delta d = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;deld;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tdels = delta s = &quot; &lt;&lt; BEreq::ddcomlegacy-&gt;dels &lt;&lt; EOM;


      // Loop corrections and pole removal.

      // Option loop&lt;bool&gt;: If true, include 1-loop effects discussed in
      // Drees Nojiri Phys.Rev. D48 (1993) 3483-3501 (default: true)
      BEreq::ddmssmcom-&gt;dddn = runOptions-&gt;getValueOrDef&lt;bool&gt;(true,&quot;loop&quot;);

      // Option pole&lt;bool&gt;: If true, include pole in nuclear scattering cross-section.
      // If false, approximate squark propagator as 1/m_sq^2 (default: false)
      BEreq::ddmssmcom-&gt;ddpole = runOptions-&gt;getValueOrDef&lt;bool&gt;(false,&quot;pole&quot;);

      // Some version notes:
      // The default in DS5 is  for both these options to be false (tree-level cross-section with pole removed).
      // The default in DS6 is to use Drees-Nojiri (1 loop) with the pole removed, which isn't an
      // option in the official DS5.1.3.  The version in GAMBIT is patched to implement this option though,
      // so we use it as the default here.

      // Calling DarkSUSY subroutine dsddgpgn(gps,gns,gpa,gna)
      // to set all four couplings.
      std::vector&lt;double&gt; DDcouplings=BEreq::get_DD_couplings();
      double factor =
      /// Option rescale_couplings&lt;double&gt;: Rescaling factor for WIMP-nucleon couplings (default 1.)
      runOptions-&gt;getValueOrDef&lt;double&gt;(1., &quot;rescale_couplings&quot;);
      result.gps = factor*DDcouplings[0];// *= factor;
      result.gns = factor*DDcouplings[1];// *= factor;
      result.gpa = factor*DDcouplings[2];// *= factor;
      result.gna = factor*DDcouplings[3];// *= factor;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;DarkSUSY dsddgpgn gives:&quot; &lt;&lt; std::endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gps = &quot; &lt;&lt; result.gps &lt;&lt; std::endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gns = &quot; &lt;&lt; result.gns &lt;&lt; std::endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gpa = &quot; &lt;&lt; result.gpa &lt;&lt; std::endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gna = &quot; &lt;&lt; result.gna &lt;&lt; EOM;
    }


    /*! \brief Get direct detection couplings from initialized MicrOmegas.
    */
    void DD_couplings_MicrOmegas(DM_nucleon_couplings &amp;result)
    {
      using namespace Pipes::DD_couplings_MicrOmegas;

      // Set proton hadronic matrix elements.
      BEreq::MOcommon-&gt;par[2] = *Param[&quot;fpd&quot;];
      BEreq::MOcommon-&gt;par[3] = *Param[&quot;fpu&quot;];
      BEreq::MOcommon-&gt;par[4] = *Param[&quot;fps&quot;];

      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;micrOMEGAs proton hadronic matrix elements set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ScalarFFPd = fpd = &quot; &lt;&lt; BEreq::MOcommon-&gt;par[2];
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tScalarFFPu = fpu = &quot; &lt;&lt; BEreq::MOcommon-&gt;par[3];
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tScalarFFPs = fps = &quot; &lt;&lt; BEreq::MOcommon-&gt;par[4] &lt;&lt; EOM;

      // Set neutron hadronic matrix elements.
      BEreq::MOcommon-&gt;par[11] = *Param[&quot;fnd&quot;];
      BEreq::MOcommon-&gt;par[12] = *Param[&quot;fnu&quot;];
      BEreq::MOcommon-&gt;par[13] = *Param[&quot;fns&quot;];

      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;micrOMEGAs neutron hadronic matrix elements set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;ScalarFFNd = fnd = &quot; &lt;&lt; BEreq::MOcommon-&gt;par[11];
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tScalarFFNu = fnu = &quot; &lt;&lt; BEreq::MOcommon-&gt;par[12];
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;\tScalarFFNs = fns = &quot; &lt;&lt; BEreq::MOcommon-&gt;par[13] &lt;&lt; EOM;

      //Set delta q.
      BEreq::MOcommon-&gt;par[5] = *Param[&quot;deltad&quot;];
      BEreq::MOcommon-&gt;par[6] = *Param[&quot;deltau&quot;];
      BEreq::MOcommon-&gt;par[7] = *Param[&quot;deltas&quot;];

      BEreq::MOcommon-&gt;par[14] = *Param[&quot;deltau&quot;];
      BEreq::MOcommon-&gt;par[15] = *Param[&quot;deltad&quot;];
      BEreq::MOcommon-&gt;par[16] = *Param[&quot;deltas&quot;];

      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;micrOMEGAs delta q set to:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;pVectorFFPd = pVectorFFNu = delta d = &quot;
        &lt;&lt; BEreq::MOcommon-&gt;par[5] &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;pVectorFFPu = pVectorFFPd = delta u = &quot;
        &lt;&lt; BEreq::MOcommon-&gt;par[6] &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;pVectorFFPs = pVectorFFNs = delta s = &quot;
        &lt;&lt; BEreq::MOcommon-&gt;par[7] &lt;&lt; EOM;

      double p1[2], p2[2], p3[2], p4[2];
      int error;
      if (runOptions-&gt;getValueOrDef&lt;bool&gt;(true, &quot;box&quot;))
        error = BEreq::nucleonAmplitudes(byVal(BEreq::FeScLoop.pointer()),
          byVal(p1), byVal(p2), byVal(p3), byVal(p4));
      else error = BEreq::nucleonAmplitudes(NULL,
              byVal(p1), byVal(p2), byVal(p3), byVal(p4));
      if(error!=0)
        DarkBit_error().raise(LOCAL_INFO,
            &quot;micrOMEGAs nucleonAmplitudes function failed with &quot;
            &quot;error code &quot; + std::to_string(error) + &quot;.&quot;);

      // Rescaling to agree with DarkSUSY convention:
      result.gps = p1[0]*2;
      result.gpa = p2[0]*2;
      result.gns = p3[0]*2;
      result.gna = p4[0]*2;

      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot;micrOMEGAs nucleonAmplitudes gives:&quot; &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gps: &quot; &lt;&lt; result.gps &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gns: &quot; &lt;&lt; result.gns &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gpa: &quot; &lt;&lt; result.gpa &lt;&lt; endl;
      logger() &lt;&lt; LogTags::debug &lt;&lt; &quot; gna: &quot; &lt;&lt; result.gna &lt;&lt; EOM;
    }

    /// Simple calculator of the spin-independent WIMP-proton cross-section
    void sigma_SI_p_simple(double &amp;result)
    {
      using namespace Pipes::sigma_SI_p_simple;
      double gps = Dep::DD_couplings-&gt;gps;
      double reduced_mass = *Dep::mwimp * m_proton / (*Dep::mwimp + m_proton);
      result = gev2cm2/pi*pow(reduced_mass*gps,2.0);
    }

    /// Simple calculator of the spin-independent WIMP-neutron cross-section
    void sigma_SI_n_simple(double &amp;result)
    {
      using namespace Pipes::sigma_SI_n_simple;
      double gns = Dep::DD_couplings-&gt;gns;
      double reduced_mass = *Dep::mwimp * m_neutron / (*Dep::mwimp + m_neutron);
      result = gev2cm2/pi*pow(reduced_mass*gns,2.0);
    }

    /// Simple calculator of the spin-dependent WIMP-proton cross-section
    void sigma_SD_p_simple(double &amp;result)
    {
      using namespace Pipes::sigma_SD_p_simple;
      double gpa = Dep::DD_couplings-&gt;gpa;
      double reduced_mass = *Dep::mwimp * m_proton / (*Dep::mwimp + m_proton);
      result = 3.0*gev2cm2/pi*pow(reduced_mass*gpa,2.0);
    }

    /// Simple calculator of the spin-dependent WIMP-neutron cross-section
    void sigma_SD_n_simple(double &amp;result)
    {
      using namespace Pipes::sigma_SD_n_simple;
      double gna = Dep::DD_couplings-&gt;gna;
      double reduced_mass = *Dep::mwimp * m_neutron / (*Dep::mwimp + m_neutron);
      result = 3.0*gev2cm2/pi*pow(reduced_mass*gna,2.0);
    }

    /// Calculation of SI cross sections at a reference momentum q0
    /// for the fermionic Higgs portal models
    /// If required add equivalent function for spin-dependent cross section
    void sigma_SI_vnqn_FermionicHiggsPortal(map_intpair_dbl &amp;result)
    {
      using namespace Pipes::sigma_SI_vnqn_FermionicHiggsPortal;

      NREO_DM_nucleon_couplings wilsonCoeffs = *Dep::DD_nonrel_WCs;

      double q0 = 0.04; // reference momentum transfer: 40 MeV
      double gps = (wilsonCoeffs.c0[1] + wilsonCoeffs.c1[1])/2. ;
      double gpa = (wilsonCoeffs.c0[11] + wilsonCoeffs.c1[11])/2.;
      double reduced_mass = *Dep::mwimp * m_proton / (*Dep::mwimp + m_proton);

      result[std::make_pair(0,0)] =   gev2cm2/pi*pow(reduced_mass*gps,2.0);
      result[std::make_pair(-2,0)] =  0.0;
      result[std::make_pair(2,0)] =   gev2cm2/pi*pow(reduced_mass*gpa,2.0)*pow(q0/(*Dep::mwimp)/2.0,2.0);
      result[std::make_pair(4,0)] =   0.0;
      result[std::make_pair(0,-2)] =  0.0;
      result[std::make_pair(0,2)] =   0.0;
      result[std::make_pair(0,4)] =   0.0;
    }

    /// Calculation of SD cross section at a reference momentum q0
    /// for the fermionic Higgs portal models
    void sigma_SD_vnqn_FermionicHiggsPortal(map_intpair_dbl &amp;result)
    {
      using namespace Pipes::sigma_SD_vnqn_FermionicHiggsPortal;

      /// There is no SD contribution to fermionic Higgs portal models
      /// So this is just set to 0 (or close enough)
      /// Modify if needed
      result[std::make_pair(0,0)] =   0.0;
      result[std::make_pair(-2,0)] =  0.0;
      result[std::make_pair(2,0)] =   0.0;
      result[std::make_pair(4,0)] =   0.0;
      result[std::make_pair(0,-2)] =  0.0;
      result[std::make_pair(0,2)] =   0.0;
      result[std::make_pair(0,4)] =   0.0;
    }

    /// DDCalc initialisation.

    // Using spin-independent/spin-dependent interactions only
    void DDCalc_Couplings_WIMP_nucleon(DD_coupling_container &amp;result)
    {
      using namespace Pipes::DDCalc_Couplings_WIMP_nucleon;
      result.coeff_structure = 1;
      result.DM_nucleon_coeffs = *Dep::DD_couplings;
    }

    // Using non-relativistic Wilson Coefficient coupling structure
    void DDCalc_Couplings_NR_WCs(DD_coupling_container &amp;result)
    {
      using namespace Pipes::DDCalc_Couplings_NR_WCs;
      result.coeff_structure = 2;
      result.DD_nonrel_WCs = *Dep::DD_nonrel_WCs;
    }

    //////////////////////////////////////////////////////////////////////////
    //
    //          Direct detection rate and likelihood routines
    //
    //////////////////////////////////////////////////////////////////////////

    /// Defines a prototypical DDCalc result extractor
    #define DDCALC_RESULT(EXPERIMENT, TYPE, NAME)                                  \
    void CAT_3(EXPERIMENT,_Get,NAME)(TYPE &amp;result)                                 \
    {                                                                              \
      using namespace Pipes::CAT_3(EXPERIMENT,_Get,NAME);                          \
      TYPE temp_result = BEreq::CAT(DD_,NAME)(BEreq::DD_Experiment(STRINGIFY(EXPERIMENT)));  \
      if (Utils::isnan(temp_result))                                               \
      {                                                                            \
        /* DarkBit_error().raise(LOCAL_INFO, &quot;Got NaN value from DDCalc.&quot;); */     \
        /* TODO: Raise a proper error here -- NaNs should be fixed. */             \
        invalid_point().raise(&quot;Got NaN value from DDCalc! This need fixing!&quot;);     \
      }                                                                            \
      result = temp_result;                                                        \
    }

    #define DDCALC_BIN(EXPERIMENT, TYPE, NAME)                                     \
    void CAT_3(EXPERIMENT,_GetBin,NAME)(std::vector&lt;double&gt; &amp;result)               \
    {                                                                              \
      using namespace Pipes::CAT_3(EXPERIMENT,_GetBin,NAME);                       \
      result.clear();                                                              \
      int nbins;                                                                   \
      nbins = BEreq::DD_Bins(BEreq::DD_Experiment(STRINGIFY(EXPERIMENT)));         \
      for (int ibin=1;ibin&lt;=nbins;ibin++) {                                        \
        result.push_back(                                                          \
        BEreq::CAT(DD_Bin,NAME)(BEreq::DD_Experiment(STRINGIFY(EXPERIMENT)),ibin)); } \
    }

    /// Defines functions to perform the DDCalc internal rate calculations,
    /// and extract the results and log likelihoods, for the designated experiment.
    #define DD_EX(EXPERIMENT)                                                      \
      /* Calculations */                                                           \
      void CAT(EXPERIMENT,_Calc)(bool &amp;result)                                     \
      {                                                                            \
        using namespace Pipes::CAT(EXPERIMENT,_Calc);                              \
        BEreq::DD_CalcRates(BEreq::DD_Experiment(STRINGIFY(EXPERIMENT)));          \
        result = true;                                                             \
      }                                                                            \
      /* Results */                                                                \
      DDCALC_RESULT(EXPERIMENT, int,    Events)                                    \
      DDCALC_RESULT(EXPERIMENT, double, Background)                                \
      DDCALC_RESULT(EXPERIMENT, double, Signal)                                    \
      DDCALC_RESULT(EXPERIMENT, double, SignalSI)                                  \
      DDCALC_RESULT(EXPERIMENT, double, SignalSD)                                  \
      DDCALC_RESULT(EXPERIMENT, int,    Bins)                                      \
      DDCALC_RESULT(EXPERIMENT, double, LogLikelihood)                             \
      DDCALC_BIN(EXPERIMENT, int,    Events)                                       \
      DDCALC_BIN(EXPERIMENT, double, Background)                                   \
      DDCALC_BIN(EXPERIMENT, double, Signal)                                       \

    // Experiments
    DD_EX(XENON100_2012)        // Aprile et al., PRL 109, 181301 (2013) [arxiv:1207.5988]
    DD_EX(XENON1T_2017)         // Aprile et al., PRL 119, 181301 (2017) [arxiv:1705.06655]
    DD_EX(XENON1T_2018)         // Aprile et al., May 28 talk at Gran Sasso.
    DD_EX(DARWIN)               // M. Schumann et al., [arXiv:1506.08309]
    DD_EX(LUX_2013)             // Akerib et al., PRL 112, 091303 (2014) [arxiv:1310.8214]
    DD_EX(LUX_2015)             // D.S. Akerib et al., PRL 116, 161301 (2016) [arXiv:1512.03506]
    DD_EX(LUX_2016)             // D.S. Akerib et al., PRL 118, 021303 (2017) [arxiv:1608.07648]
    DD_EX(LZ)                   // LZ TDR, [arXiv:1509.02910]
    DD_EX(PandaX_2016)          // A. Tan et al., PRL 117, 121303 (2016) [arxiv:1607.07400]
    DD_EX(PandaX_2017)          // X. Cui et al., PRL 119, 181302 (2017) [arxiv:1708.06917]
    DD_EX(DarkSide_50)          // P. Agnes et al., [arXiv:1802.07198]
    DD_EX(DarkSide_50_S2)       // P. Agnes et al., [arXiv:1802.06994]
    DD_EX(CRESST_II)            // G. Angloher et al., [arXiv:1509.01515]
    DD_EX(CRESST_III)           // G. Angloher et al., [arXiv:1904.00498]
    DD_EX(SuperCDMS_2014)       // Agnese et al., PRL 112, 241302 (2014) [arxiv:1402.7137]
    DD_EX(CDMSlite)             // Agnese et al., PRL 116, 071301 (2015) [arxiv:1509.02448]
    DD_EX(SIMPLE_2014)          // Felizardo et al., PRD 89, 072013 (2014) [arxiv:1404.4309]
    DD_EX(PICO_2L)              // C. Amole et al., PRD 93, 061101 (2016) [arXiv:1601.03729]
    DD_EX(PICO_60_F)            // C. Amole et al., PRD 93, 052014 (2016) [arXiv:1510.07754]
    DD_EX(PICO_60_I)            // C. Amole et al., PRD 93, 052014 (2016) [arXiv:1510.07754]
    DD_EX(PICO_60)              // C. Amole et al., PRD 93, 052014 (2016) [arXiv:1510.07754]
    DD_EX(PICO_60_2017)         // C. Amole et al., arXiv:1702.07666
    DD_EX(PICO_60_2019)         // C. Amole et al., arXiv:1902.04031
    DD_EX(PICO_500)             // S. Fallows, talk at TAUP 2017
    DD_EX(LZ_2022)              // J. Aalbers et al., arXiv:2207.03764
    DD_EX(PandaX_4T)            // Y. Meng et al., PRL 127 (2021) 26, 261802 [arXiv:2107.13438]


    // Just in case, to make sure we don't mess with other things elsewhere.
    #undef DD_EX

    // XENON1T S2 Electron Recoil Log-Likelihood using obscura
    void calc_XENON1T_ER_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_XENON1T_ER_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_e = *Dep::sigma_e/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Set_Sigma_Electron(sigma_e);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_ER experiment = BEreq::XENON1T_S2_ER();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // DarkSide50 S2 Electron Recoil Log-Likelihood using obscura
    void calc_DarkSide50_ER_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_DarkSide50_ER_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_e = *Dep::sigma_e/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Set_Sigma_Electron(sigma_e);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_ER experiment = BEreq::DarkSide50_S2_ER();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // DarkSide50 S2 Electron Recoil 2023 Log-Likelihood using obscura
    void calc_DarkSide50_ER_2023_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_DarkSide50_ER_2023_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_e = *Dep::sigma_e/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Set_Sigma_Electron(sigma_e);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_ER experiment = BEreq::DarkSide50_S2_ER_2023();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // PandaX-4T S2 Electron Recoil Log-Likelihood using obscura
    void calc_PandaX_4T_ER_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_PandaX_4T_ER_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_e = *Dep::sigma_e/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Set_Sigma_Electron(sigma_e);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_ER experiment = BEreq::PandaX_4T_S2_ER();
      result = experiment.Log_Likelihood(DM, SHM);
    }

// TODO: Not implemented in obscura, uncomment when it is
/*
    // LZ S2 Electron Recoil Log-Likelihood using obscura
    void calc_LZ_ER_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_LZ_ER_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_e = *Dep::sigma_e/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Set_Sigma_Electron(sigma_e);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_ER experiment = BEreq::LZ_S2_ER();
      result = experiment.Log_Likelihood(DM, SHM);
    }
*/

    // SENSEI at MINOS Electron Recoil Log-Likelihood using obscura
    void calc_SENSEI_at_MINOS_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_SENSEI_at_MINOS_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_e = *Dep::sigma_e/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Set_Sigma_Electron(sigma_e);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Crystal experiment = BEreq::SENSEI_at_MINOS();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // CDMS HVeV Electron Recoil Log-Likelihood using obscura
    void calc_CDMS_HVeV_2020_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_CDMS_HVeV_2020_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_e = *Dep::sigma_e/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Set_Sigma_Electron(sigma_e);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Crystal experiment = BEreq::CDMS_HVeV_2020();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // DAMIC M 2023 Electron Recoil Log-Likelihood using obscura
    void calc_DAMIC_M_2023_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_DAMIC_M_2023_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_e = *Dep::sigma_e/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Set_Sigma_Electron(sigma_e);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Crystal experiment = BEreq::DAMIC_M_2023();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // XENON1T Migdal Log-Likelihood using obscura
    void calc_XENON1T_Migdal_LogLikelihood(double &amp;result)
    {
      using namespace Pipes::calc_XENON1T_Migdal_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_p = *Dep::sigma_SI_p/gev2cm2; // in GeV^-2
      double sigma_n = runOptions-&gt;getValueOrDef&lt;bool&gt;(false, &quot;equal_p_and_n_xsecs&quot;) ? *Dep::sigma_SI_p/gev2cm2 : *Dep::sigma_SI_n/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Unfix_Coupling_Ratios();
      DM.Set_Sigma_Proton(sigma_p);
      DM.Set_Sigma_Neutron(sigma_n);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_Migdal experiment = BEreq::XENON1T_S2_Migdal();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // DarkSide50 Migdal Log-Likelihood using obscura
    void calc_DarkSide50_Migdal_LogLikelihood(double &amp;result)
    {
      using namespace Pipes::calc_DarkSide50_Migdal_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_p = *Dep::sigma_SI_p/gev2cm2; // in GeV^-2
      double sigma_n = runOptions-&gt;getValueOrDef&lt;bool&gt;(false, &quot;equal_p_and_n_xsecs&quot;) ? *Dep::sigma_SI_p/gev2cm2 : *Dep::sigma_SI_n/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Unfix_Coupling_Ratios();
      DM.Set_Sigma_Proton(sigma_p);
      DM.Set_Sigma_Neutron(sigma_n);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_Migdal experiment = BEreq::DarkSide50_S2_Migdal();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // DarkSide50 Migdal 2023 Log-Likelihood using obscura
    void calc_DarkSide50_Migdal_2023_LogLikelihood(double &amp;result)
    {
      using namespace Pipes::calc_DarkSide50_Migdal_2023_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_p = *Dep::sigma_SI_p/gev2cm2; // in GeV^-2
      double sigma_n = runOptions-&gt;getValueOrDef&lt;bool&gt;(false, &quot;equal_p_and_n_xsecs&quot;) ? *Dep::sigma_SI_p/gev2cm2 : *Dep::sigma_SI_n/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Unfix_Coupling_Ratios();
      DM.Set_Sigma_Proton(sigma_p);
      DM.Set_Sigma_Neutron(sigma_n);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_Migdal experiment = BEreq::DarkSide50_S2_Migdal_2023();
      result = experiment.Log_Likelihood(DM, SHM);
    }

    // PandaX 4T Migdal Log-Likelihood using obscura
    void calc_PandaX_4T_Migdal_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_PandaX_4T_Migdal_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_p = *Dep::sigma_SI_p/gev2cm2; // in GeV^-2
      double sigma_n = runOptions-&gt;getValueOrDef&lt;bool&gt;(false, &quot;equal_p_and_n_xsecs&quot;) ? *Dep::sigma_SI_p/gev2cm2 : *Dep::sigma_SI_n/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Unfix_Coupling_Ratios();
      DM.Set_Sigma_Proton(sigma_p);
      DM.Set_Sigma_Neutron(sigma_n);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_Migdal experiment = BEreq::PandaX_4T_S2_Migdal();
      result = experiment.Log_Likelihood(DM, SHM);
    }

// TODO: Not implemented in obscura, uncomment when it is
/*
    // LZ Migdal Log-Likelihood using obscura
    void calc_LZ_Migdal_LogLikelihood(double&amp; result)
    {
      using namespace Pipes::calc_LZ_Migdal_LogLikelihood;

      // 1. DM halo model (in powers of GeV)
      LocalMaxwellianHalo LH = *Dep::LocalHalo_GeV;
      double fraction = *Dep::RD_fraction;
      obscura_default::obscura::Standard_Halo_Model SHM(LH.rho0*fraction, LH.v0, LH.vrot, LH.vesc);

      // 2. DM Particle with SI interactions
      double mDM = *Param[&quot;mDM&quot;]; // in GeV
      double mAp = *Param[&quot;mAp&quot;]; // in GeV
      double sigma_p = *Dep::sigma_SI_p/gev2cm2; // in GeV^-2
      double sigma_n = runOptions-&gt;getValueOrDef&lt;bool&gt;(false, &quot;equal_p_and_n_xsecs&quot;) ? *Dep::sigma_SI_p/gev2cm2 : *Dep::sigma_SI_n/gev2cm2; // in GeV^-2

      obscura_default::obscura::DM_Particle_SI DM(mDM);
      DM.Unfix_Coupling_Ratios();
      DM.Set_Sigma_Proton(sigma_p);
      DM.Set_Sigma_Neutron(sigma_n);
      DM.Set_FormFactor_DM(&quot;General&quot;, mAp);

      // 3. Experiment
      obscura_default::obscura::DM_Detector_Ionization_Migdal experiment = BEreq::LZ_S2_Migdal();
      result = experiment.Log_Likelihood(DM, SHM);
    }
*/

  }
}
</code></pre><hr><p>Updated on 2025-02-12 at 16:10:35 +0000</p></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=/license/>License</a></li></ul></div></div></div></footer><script src=/js/bootstrap.min.862c9eb8ab97f8c1c8584b21ce31113d8553917669561b040011b0061009a0b6c7a6b61fb659f56eabfa9f45259f001417dba1d65b229f685f3cdbb709482f8e.js integrity="sha512-hiyeuKuX+MHIWEshzjERPYVTkXZpVhsEABGwBhAJoLbHprYftln1bqv6n0UlnwAUF9uh1lsin2hfPNu3CUgvjg==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.3fa03d1d36ae7a66d6d5d2e19796832d40b4a5417eaaae1dfba8837d033467084e8c051f25aee596d415422573116115ccc5c2b29970d3490dafdce1a920a402.js integrity="sha512-P6A9HTauembW1dLhl5aDLUC0pUF+qq4d+6iDfQM0ZwhOjAUfJa7lltQVQiVzEWEVzMXCsplw00kNr9zhqSCkAg==" crossorigin=anonymous defer></script>
<script src=/main.min.04459eeb2d9d601a3ccc10d2699fb84f0442d5f5d3a16372b023be7564838ed2a755b908598f715d6b42c0be95895835b2e872f4fa4acd028ef3904671a92f1a.js integrity="sha512-BEWe6y2dYBo8zBDSaZ+4TwRC1fXToWNysCO+dWSDjtKnVbkIWY9xXWtCwL6ViVg1suhy9PpKzQKO85BGcakvGg==" crossorigin=anonymous defer></script>
<script src=https://gambitbsm.org/index.min.b6cf5ec934cb1c2eb743cb06f00d0db6ec9eaf3baacb05d24e75b9bb24b9736861023f69944ee70879d9d3608c591e9621193a2b1af8ab230c11a16da0ab8a1f.js integrity="sha512-ts9eyTTLHC63Q8sG8A0NtuyerzuqywXSTnW5uyS5c2hhAj9plE7nCHnZ02CMWR6WIRk6Kxr4qyMMEaFtoKuKHw==" crossorigin=anonymous defer></script></body></html>